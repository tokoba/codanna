```markdown
# パフォーマンス

Codanna のパフォーマンス特性と最適化。

## パーサー性能

750 シンボルのテストファイルでのベンチマーク:

| Language | 解析速度 | 目標比 (10k/s) | ステータス |
|----------|---------------|-------------------|--------|
| **Rust** | 91,318 symbols/sec | 9.1 倍高速 | 本番 |
| **Python** | 75,047 symbols/sec | 7.5 倍高速 | 本番 |
| **TypeScript** | 82,156 symbols/sec | 8.2 倍高速 | 本番 |
| **PHP** | 68,432 symbols/sec | 6.8 倍高速 | 本番 |
| **Go** | 74,655 symbols/second | 7.5 倍高速 | 本番 |

パフォーマンスベンチマークを実行:
```bash
codanna benchmark all          # すべてのパーサーをテスト
codanna benchmark python       # 特定言語をテスト
codanna benchmark rust --file src/main.rs  # カスタムファイルでテスト
```

## 検索性能

- **シンボル検索**: <10ms
- **セマンティック検索**: ~160ms (埋め込み生成込み)
- **ベクターアクセス**: OS ページキャッシュウォームアップ後 <1μs
- **MCP 応答時間**: ~300ms (HTTP/HTTPS)、160ms (stdio)

## メモリ使用量

- **1 シンボルあたり**: ~100 バイト
- **モデルストレージ**: ~150MB (初回使用時にダウンロード)
- **インデックスストレージ**: 数 MB (コードベースのサイズによる)
- **ベクターキャッシュ**: 384 次元ベクターをメモリマップ

## 最適化のヒント

### インデックス作成

**スレッド数を制御:**
```bash
codanna index . --threads 16
```

**大きなファイルをスキップ:**
```toml
[indexing]
max_file_size_mb = 10
```

**.codannaignore を使用:**
```
target/
node_modules/
dist/
build/
```

### 検索

**起動後最初の検索は遅い場合あり** - キャッシュウォームアップが行われる

**言語フィルターを使用:**
```bash
# 言語で検索空間を縮小
codanna mcp semantic_search_docs query:"auth" lang:rust
```

**結果数を調整:**
```bash
# 結果が少ないほど高速
codanna mcp semantic_search_docs query:"config" limit:3
```

### サーバーモード

**ウォッチ間隔:**
```toml
[server]
watch_interval = 5  # インデックスチェック間隔（秒）
```

間隔を短くするとチェック頻度は上がるが CPU 使用率も高くなる。

**キャッシュ設定:**
```toml
[performance]
cache_size_mb = 100
vector_cache_size = 10000
```

## アーキテクチャのハイライト

### メモリマップストレージ

異なるアクセスパターン向けに 2 つのキャッシュ:
- `symbol_cache.bin` - FNV-1a ハッシュによるシンボル検索
- `segment_0.vec` - 384 次元ベクター

### ロックフリー並行処理

DashMap によるシンボルの並列読み取り、書き込み調整は単一のライターロックで実施。

### シングルパスインデックス

シンボル、関係、埋め込みを 1 回の AST 走査で抽出。

### ホットリロード

500ms デバウンス付きファイルウォッチャーが変更されたファイルのみを再インデックス。

## パフォーマンス目標

- **すべての操作が ~300ms 以内に完了**（安定）
- **500ms を超える退行は調査対象**
- **MCP ガイダンスのオーバーヘッドは <1ms**

変更のたびに性能をテストすること。

## 監視

### インデックス統計
```bash
codanna mcp get_index_info --json
```

表示内容:
- 総シンボル数
- 言語別シンボル数
- 種類別シンボル数
- インデックスタイムスタンプ

### 特定ファイルのベンチマーク
```bash
codanna benchmark rust --file src/large_file.rs
```

## パフォーマンスが遅い場合のトラブルシューティング

### インデックス作成が遅い

1. スレッド数を確認: `codanna index . --threads 8`
2. `.codannaignore` で不要なディレクトリをスキップ
3. `max_file_size_mb` を増やすか大きな生成ファイルをスキップ

### 検索が遅い

1. 最初の検索はキャッシュウォームアップ - 2 回目以降は高速
2. 言語フィルターで検索空間を縮小
3. 結果数を減らす
4. キャッシュ用に十分な RAM があるか確認

### メモリ使用量が高い

1. 設定でキャッシュサイズを減らす
2. インデックス対象ファイルを減らす
3. メモリリークをチェック（見つけた場合は報告）

## 参照

- [アーキテクチャ](../architecture/) - システム内部
- [設定](../user-guide/configuration.md) - パフォーマンス調整オプション
- [CLI リファレンス](../user-guide/cli-reference.md) - ベンチマークコマンド
```