# parsers\README.md Review

## TL;DR

- このファイルは各言語の**パーサ/解決テスト**を格納するディレクトリ構造と、**Rustの統合テストへのモジュール追加方法**を示すドキュメント。
- 公開APIやコアロジックの定義は**該当なし**（このチャンクはREADMEのみ）。Rust側では`tests/parsers_tests.rs`に`#[path]`で各言語テストモジュールを参照する方式が例示される。
- 複雑箇所は各言語固有の**解決（resolution）**ルール（TypeScriptのtsconfig extends、C/C++のincludeパス、名前空間/テンプレートなど）。
- 重大リスクはテストの**並行実行時のフィクスチャ競合**、**相対パスの壊れやすさ**、**環境依存（OS/ツールチェーン）の差異**。READMEでは対策が記載されていない。
- 実装詳細（API、データ契約、内部依存）はこのチャンクには**現れない**。以降の提案は一般的ベストプラクティスに基づく。

## Overview & Purpose

このREADMEは、言語別のパーサおよび解決テストの配置方針、テストカテゴリ（Resolution/Parser/Behavior）と、Rust統合テストに各言語テストファイルを**モジュールとして取り込む方法**を説明するためのもの。目的は以下の通り。

- 言語別テストの**ディレクトリ構造の共有**。
- 新しいテストの**追加手順**の標準化。
- 現在用意されているテストの**概要**（TypeScript、C、C++のResolutionテスト）。

このファイル自体にロジックやAPIはなく、**ドキュメント**のみであるため、コードレベルの安全性や性能評価は**不明**。

## Structure & Key Components

| 種別 | 名前 | 公開範囲 | 責務 | 複雑度 |
|------|------|----------|------|--------|
| Dir | parsers/typescript/ | 内部（テスト用） | TypeScriptのパーサ/解決テスト格納 | Med |
| Dir | parsers/c/ | 内部（テスト用） | Cのパーサ/解決テスト格納 | Med |
| Dir | parsers/cpp/ | 内部（テスト用） | C++のパーサ/解決テスト格納 | Med |
| Dir | parsers/python/ | 内部（テスト用/予定） | Pythonのパーサ/解決テスト格納 | Low（未実装） |
| Dir | parsers/go/ | 内部（テスト用/予定） | Goのパーサ/解決テスト格納 | Low（未実装） |
| Dir | parsers/php/ | 内部（テスト用/予定） | PHPのパーサ/解決テスト格納 | Low（未実装） |
| Dir | parsers/rust/ | 内部（テスト用/予定） | Rustのパーサ/解決テスト格納 | Low（未実装） |
| File | parsers/README.md | 公開（リポジトリ内） | ディレクトリ/テスト追加手順/カテゴリ/現況の説明 | Low |

### Dependencies & Interactions

- 内部依存:
  - `tests/parsers_tests.rs`が`#[path]`属性で各言語テストファイル（例: `parsers/python/test_resolution.rs`）を**モジュールとして取り込む**。このREADMEに例が記載されるが、`parsers_tests.rs`や各テストの中身は**このチャンクには現れない**。
- 外部依存（使用クレート・モジュール）:
  - 不明（このチャンクには現れない）。テスト実行には`cargo test`（Rustの標準テストランナー）が想定されるが、追加クレート（例: `serial_test`, `tempfile`, 言語ツールチェーン等）の利用有無は**不明**。
- 被依存推定:
  - CI/CDのテストジョブ、`cargo test`実行フローがこれらディレクトリのテストを**間接的に利用**。
  - パーサ/リゾルバ本体のクレートが**統合テスト内から参照**される可能性が高いが、詳細は**不明**。

## API Surface (Public/Exported) and Data Contracts

| API名 | シグネチャ | 目的 | Time | Space |
|-------|-----------|------|------|-------|
| 該当なし | 該当なし | このチャンクはREADMEのみでAPIは存在しない | 不明 | 不明 |

- 各APIの詳細説明:
  1. 目的と責務: 該当なし
  2. アルゴリズム（ステップ分解）: 該当なし
  3. 引数: 該当なし
     | 引数名 | 型 | 必須 | 説明 |
     |--------|----|------|------|
     | 該当なし | 該当なし | 該当なし | 該当なし |
  4. 戻り値:
     | 型 | 説明 |
     |----|------|
     | 該当なし | 該当なし |
  5. 使用例: 該当なし（ただしモジュール取り込み例は下記参照）
  6. エッジケース: 該当なし

参考の取り込み例（README記載のまま）:

```rust
// In tests/parsers_tests.rs
#[path = "parsers/python/test_resolution.rs"]
mod test_python_resolution;
```

## Walkthrough & Data Flow

- 新規テスト追加フロー（README準拠）:
  1. 対象言語ディレクトリ（例: `parsers/typescript/`）に**テストファイルを作成**。
  2. `tests/parsers_tests.rs`に`#[path = "..."] mod ...;`を**追記**して統合テストに**組み込む**。
- 実行時のデータフロー（推定・一般的）:
  - `cargo test`が`tests/parsers_tests.rs`をビルドし、`#[path]`で指定されたファイルを**同一クレートのモジュール**として取り込む。
  - 各テストモジュール内の`#[test]`関数が起動し、言語別の**解決（tsconfig/include pathなど）**や**パーサ**に入力を与えて**検証**する。
  - 具体的な呼び出し対象（関数・型）は**このチャンクには現れない**ため不明。

## Complexity & Performance

- 時間計算量・空間計算量: **不明**（テスト対象や入力サイズに依存）。
- ボトルネックの可能性:
  - 大規模なプロジェクト構造を用いた解決テスト（多段extends/深いincludeチェーン）は**I/Oコスト**が増大。
  - 言語ツールチェーン（例: TypeScript, C/C++コンパイラヘッダ探索）を使う場合、**外部プロセス**や**ファイルシステムアクセス**が支配的になりうる。
- スケール限界:
  - テストを並行実行する場合、**共有フィクスチャ**や**同一パス使用**が競合を引き起こし、性能劣化や失敗の原因になりうる。

## Edge Cases, Bugs, and Security

セキュリティチェックリスト（このチャンク内のコードはREADMEのみのため、下記は一般的観点の評価。実装は不明）:
- メモリ安全性: Rustのテストであれば安全性は**言語保証**により高いが、FFIや外部プロセス連携の有無は**不明**。
- インジェクション: **パス解決テスト**で外部入力を扱う場合、Path Traversalのリスクがあるが、テスト内で制御されたフィクスチャを使えば低減可能。具体的対策は**不明**。
- 認証・認可: 該当なし（テスト用途。認証機構に触れるコードはこのチャンクには現れない）。
- 秘密情報: **ハードコードされた機密情報**や**ログ漏えい**の記述は**不明**。テストで環境変数を利用する場合はマスキングが必要。
- 並行性: `cargo test`はデフォルトで並行実行。**同一一時ディレクトリの共有**や**グローバル状態**を用いると**競合**のリスク。対策の記載は**不明**。

エッジケース一覧（一般的に想定されるケース。実装・状態は不明）:

| エッジケース | 入力例 | 期待動作 | 実装 | 状態 |
|-------------|--------|----------|------|------|
| 空の設定ファイル（TypeScript） | `tsconfig.json`が`{}` | デフォルト値で解決、パスが適切に解釈される | このチャンクには現れない | 不明 |
| 循環extends（TypeScript） | A extends B、B extends A | 循環検出してエラー/防止 | このチャンクには現れない | 不明 |
| 不存在のincludeパス（C/C++） | `#include "missing.h"` | 失敗として報告、適切なエラーメッセージ | このチャンクには現れない | 不明 |
| システムヘッダとユーザヘッダの衝突（C/C++） | `#include <vector>`と同名ユーザヘッダ | システム優先/規則に従う | このチャンクには現れない | 不明 |
| 非ASCIIファイル名 | `src/ßpecial.ts` | 正しく解決・パースできる | このチャンクには現れない | 不明 |
| 非正規パスの正規化 | `./a/../b.ts` | 正規化して期待のファイルに解決 | このチャンクには現れない | 不明 |
| 深い依存チェーン | 10+段のinclude/extends | スタック/パフォーマンスに問題なく処理 | このチャンクには現れない | 不明 |

## Design & Architecture Suggestions

- ディレクトリごとの**README補足**:
  - 各言語ディレクトリに、その言語特有の解決規則（例: tsconfigの`paths`/`extends`、C/C++のヘッダ探索順）とテストポリシーを明記。
- テスト命名規約の導入:
  - `test_resolution_*.rs`, `test_parser_*.rs`, `test_behavior_*.rs`などの**一貫した命名**でカテゴリを明確化。
- フィクスチャ管理の標準化:
  - 一時ディレクトリ作成を**ユーティリティ関数**に集約（`tempfile`などの利用を推奨）。並行テストに安全な**ユニークパス**を付与。
- モジュール取り込みの集中管理:
  - `tests/parsers_tests.rs`からの`#[path]`列挙を**自動生成**（ビルドスクリプト`build.rs`やディレクトリ走査）にする案。手動更新の漏れを防止。
- 環境依存の明確化:
  - OS差異（パス区切り、システムヘッダの場所）や外部ツールチェーンの前提を**ドキュメント化**。

## Testing Strategy (Unit/Integration) with Examples

- 戦略:
  - Resolutionテストは小さな**合成プロジェクト**をフィクスチャとして用意し、入出力（解決結果）を**スナップショット**で検証。
  - Parserテストは最小/代表的構文を網羅し、**シンボル抽出**結果（型、関数、クラスなど）を検証。
  - Behaviorテストは言語仕様の**曖昧/バージョン差異**を明示し、期待動作を固定。

- Rust統合テストでのモジュール取り込み例（README記載の方式に準拠）:

```rust
// tests/parsers_tests.rs
#[path = "parsers/typescript/test_resolution_pipeline.rs"]
mod test_ts_resolution;

// 例: テスト関数のスケルトン（擬似コードコメント）
#[test]
fn tsconfig_extends_chain_is_resolved() {
    // setup: 一時ディレクトリに tsconfig.json 群を作成（A extends B extends C）
    // call: TypeScriptの解決関数を呼ぶ（具体APIはこのチャンクには現れない）
    // assert: paths/aliases が期待どおりに C→B→A の優先順で解決される
}
```

- Cのinclude解決テスト例（擬似コードコメント）:

```rust
#[test]
fn c_include_paths_are_resolved_with_system_headers() {
    // setup: ユーザヘッダとシステムヘッダの両方を用意
    // call: Cの解決関数を呼ぶ（具体APIはこのチャンクには現れない）
    // assert: <header> はシステムパス、"header" はユーザパスを優先
}
```

- 並行性対策（テスト用）:
  - 共有状態/同一ディレクトリを使うテストには**直列実行**アトリビュート（例: `serial_test`）の採用を検討。
  - フィクスチャは**テストケースごとにユニーク**に作成し、終了時に**確実に削除**。

## Refactoring Plan & Best Practices

- READMEの拡充:
  - テスト作成ガイドライン（命名、フィクスチャ、並行性、外部依存の扱い）を**明文化**。
- テストユーティリティクレート（内部）:
  - 使い回す**フィクスチャ生成**、**パス正規化**、**スナップショットアサート**を共通化。
- 自動検出/登録:
  - `parsers/**/test_*.rs`を**自動列挙**して`mod`登録する仕組みで**人為的漏れ**を防止。
- クロスプラットフォーム検証:
  - Windows/Linux/macOSの差異を**CIマトリクス**で回し、パスやシステムヘッダの差異を検証。
- ドキュメントとテストの同期:
  - 言語仕様更新（TypeScriptバージョン、C++標準など）に伴う**期待値更新プロセス**を用意。

## Observability (Logging, Metrics, Tracing)

- ロギング:
  - テスト内で**解決手順のログ**（探索したパス、選択理由、マッチ結果）を出力可能にし、失敗時の診断性を向上。
- メトリクス:
  - テストケースごとの**実行時間**、**I/O回数**を収集（簡易で良い）。重いテストの特定に役立つ。
- トレーシング:
  - 複雑な解決（多段extends/深いinclude）に対してステップごとの**トレースID**を付与するとデバッグ容易化。ただし実装は**不明**。

## Risks & Unknowns

- 不明点:
  - 実際のパーサ/リゾルバの**API・実装**、外部依存（クレート/ツールチェーン）、テスト実行環境の詳細は**このチャンクには現れない**。
- リスク:
  - **相対パス**や`#[path]`指定の**壊れやすさ**（ファイル移動に弱い）。
  - **並行テスト**によるフィクスチャ競合/レースコンディション。
  - **環境依存**（OS差異、システムヘッダ位置、TypeScriptバージョン差異）で再現性が低下する可能性。
- 対策の方向性:
  - パス生成/正規化の**ユーティリティ化**、**一時ディレクトリのユニーク化**、**CIでのクロスプラットフォーム検証**、**ドキュメント整備**。

以上。本チャンクはREADMEのみであり、**公開API・コアロジックは未掲載**。記載した設計/テスト/安全性の提案は一般的ベストプラクティスに基づくもので、実装状況は**不明**。