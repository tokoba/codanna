# integration\test_config_path_resolution.rs Review

## TL;DR

- ç›®çš„: **--config** çµŒç”±ã§èª­ã¿è¾¼ã‚“ã è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ãŠã‘ã‚‹ç›¸å¯¾çš„ãª**index_path**ãŒã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’åŸºæº–ã«æ­£ã—ãè§£æ±ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã€‚
- ä¸»è¦å¤–éƒ¨API: `Settings::load_from`, `IndexPersistence::new`, `IndexPersistence::exists`, `codanna::init::resolve_index_path`ï¼ˆã„ãšã‚Œã‚‚æœ¬ãƒ•ã‚¡ã‚¤ãƒ«å¤–ï¼‰ã€‚
- è¤‡é›‘ç®‡æ‰€: ç›¸å¯¾ãƒ‘ã‚¹ã®åŸºæº–ï¼ˆCWD vs è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰ã¨ã€ãã®å½±éŸ¿ã«ã‚ˆã‚‹**èª¤æ¤œå‡º**ã¨**æ­£ã—ã„æ¤œå‡º**ã®åˆ‡ã‚Šåˆ†ã‘ã€‚
- é‡å¤§ãƒªã‚¹ã‚¯: `std::env::set_current_dir` ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã®CWDå¤‰æ›´ã¯ä¸¦è¡Œãƒ†ã‚¹ãƒˆã§ã®ãƒ¬ãƒ¼ã‚¹ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ã€‚ç‰¹ã«**éã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•**ãªã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã®å¤‰æ›´ã€‚
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/å®‰å…¨æ€§: `unwrap`ã‚„`expect`ã«ã‚ˆã‚‹**panic**ç™ºç”Ÿå¯èƒ½æ€§ï¼ˆãƒ†ã‚¹ãƒˆã§ã¯è¨±å®¹ï¼‰ã€‚ãƒ•ã‚¡ã‚¤ãƒ«I/Oä¸­å¿ƒã§ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§ã¯Rustã®æ‰€æœ‰æ¨©ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚Šå®‰å…¨ã€‚
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: I/Oï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã€ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãƒ»å­˜åœ¨ç¢ºèªï¼‰ãŒæ”¯é…çš„ã€‚è¨ˆç®—é‡ã¯ã»ã¼å®šæ•°ã ãŒã€ç’°å¢ƒï¼ˆFS, OSï¼‰ä¾å­˜ã€‚
- æ”¹å–„ææ¡ˆ: CWDå¤‰æ›´ã‚’RAIIã‚¬ãƒ¼ãƒ‰ã§ç®¡ç†ã€ã¾ãŸã¯**ã‚·ãƒªã‚¢ãƒ«å®Ÿè¡Œ**ã«é™å®šã€‚`resolve_index_path` ã®ãƒ­ã‚°å¼·åŒ–ã¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ‹¡å¼µã€‚

## Overview & Purpose

ã“ã®çµ±åˆãƒ†ã‚¹ãƒˆã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã® `index_path` ãŒç›¸å¯¾ãƒ‘ã‚¹ã§è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã€**ç¾åœ¨ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆCWDï¼‰ã§ã¯ãªãè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€åœ¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**ã‚’åŸºæº–ã¨ã—ã¦é©åˆ‡ã«è§£æ±ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€å¤–éƒ¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ `--config` ãƒ•ãƒ©ã‚°ã§è¨­å®šã‚’èª­ã¿è¾¼ã‚€çŠ¶æ³ã‚’æ¨¡æ“¬ã—ã€ç›¸å¯¾ãƒ‘ã‚¹ãŒèª¤ã£ã¦CWDã‹ã‚‰ã®ç›¸å¯¾è§£æ±ºã«ãªã‚‰ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

å¯¾è±¡ã®æŒ™å‹•ã¯æ¬¡ã®2æ®µéšã§ç¢ºèªã•ã‚Œã¾ã™ã€‚
- èª¤æŒ™å‹•: ç›¸å¯¾ `index_path` ã‚’ãã®ã¾ã¾ `IndexPersistence` ã«æ¸¡ã™ã¨ã€èª¤ã£ãŸå ´æ‰€ã‚’å‚ç…§ã—ã¦å­˜åœ¨ã—ãªã„ã¨åˆ¤å®šã•ã‚Œã‚‹ã€‚
- æ­£æŒ™å‹•: `codanna::init::resolve_index_path(&settings, Some(&settings_path))` ã«ã‚ˆã‚‹è§£æ±ºå¾Œã®ãƒ‘ã‚¹ã‚’ä½¿ã†ã¨ã€æ­£ã—ã„å ´æ‰€ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç™ºè¦‹ã§ãã‚‹ã€‚

æ ¹æ‹ :
- èª¤æŒ™å‹•ã®æ¤œè¨¼: `wrong_persistence.exists()` ãŒ `false`ï¼ˆtest_config_relative_path_resolution: L56-L60ï¼‰
- æ­£æŒ™å‹•ã®æ¤œè¨¼: `correct_persistence.exists()` ãŒ `true`ï¼ˆtest_config_relative_path_resolution: L69-L73ï¼‰

## Structure & Key Components

| ç¨®åˆ¥ | åå‰ | å…¬é–‹ç¯„å›² | è²¬å‹™ | è¤‡é›‘åº¦ |
|------|------|----------|------|--------|
| Function | test_config_relative_path_resolution | privateï¼ˆ#[test]ï¼‰ | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç›¸å¯¾ `index_path` è§£æ±ºãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã“ã¨ã®æ¤œè¨¼ | Low |

### Dependencies & Interactions

- å†…éƒ¨ä¾å­˜
  - è©²å½“ãªã—ï¼ˆå˜ä¸€ã®ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ã¿ï¼‰

- å¤–éƒ¨ä¾å­˜ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ï¼‰

| ä¾å­˜ | ã‚¯ãƒ¬ãƒ¼ãƒˆ/ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | ç”¨é€” | å‚™è€ƒ |
|-----|----------------------|------|------|
| Settings | codanna | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ | `Settings::load_from(&Path)` ã‚’ä½¿ç”¨ï¼ˆL49ï¼‰ |
| IndexPersistence | codanna | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å­˜åœ¨åˆ¤å®š | `new(PathBuf)`, `exists()`ï¼ˆL56-L60, L69-L73ï¼‰ |
| resolve_index_path | codanna::init | ç›¸å¯¾ `index_path` ã®è§£æ±º | `resolve_index_path(&Settings, Option<&Path>)`ï¼ˆL63ï¼‰ |
| TempDir | tempfile | ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ | ãƒ†ã‚¹ãƒˆç”¨ã®éš”é›¢ç’°å¢ƒæº–å‚™ï¼ˆL13ï¼‰ |
| PathBuf/Path | std::path | ãƒ‘ã‚¹æ“ä½œ | é€£çµãƒ»æ¯”è¼ƒï¼ˆL7, L17-L21, L27, L52, L66ï¼‰ |
| std::fs | std | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª/ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»æ›¸è¾¼ | `create_dir_all`, `write`ï¼ˆL23-L24, L35, L39, L43ï¼‰ |
| std::env | std | CWDå–å¾—ãƒ»å¤‰æ›´ | `current_dir`, `set_current_dir`ï¼ˆL14, L46, L76ï¼‰ |

- è¢«ä¾å­˜æ¨å®š
  - ã“ã®ãƒ†ã‚¹ãƒˆã¯**çµ±åˆãƒ†ã‚¹ãƒˆ**ã§ã‚ã‚Šã€ä»–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰å‚ç…§ã•ã‚Œãªã„ã€‚å¯¾è±¡ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆ`codanna::init::resolve_index_path` ãªã©ï¼‰ã®æ­£ã—ã•ä¿è¨¼ã«è³‡ã™ã‚‹ã€‚

## API Surface (Public/Exported) and Data Contracts

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã®å…¬é–‹APIã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ†ã‚¹ãƒˆé–¢æ•°ã®ã¿ï¼‰ã€‚ãŸã ã—ã€ãƒ†ã‚¹ãƒˆãŒæ¤œè¨¼ã™ã‚‹å¤–éƒ¨APIã‚’ä»¥ä¸‹ã«è¨˜è¼‰ã—ã¾ã™ï¼ˆã‚·ã‚°ãƒãƒãƒ£ã¯æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®æ¨å®šã§ã‚ã‚Šã€å³å¯†ãªå®šç¾©ã¯ã€Œä¸æ˜ã€ç®‡æ‰€ã‚ã‚Šï¼‰ã€‚

| APIå | ã‚·ã‚°ãƒãƒãƒ£ | ç›®çš„ | Time | Space |
|-------|-----------|------|------|-------|
| Settings::load_from | æ¨å®š: `fn load_from(path: &Path) -> Result<Settings, E>` | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãƒ»æ§‹ç¯‰ | O(n)ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼‰ | O(n) |
| IndexPersistence::new | æ¨å®š: `fn new(index_path: PathBuf) -> IndexPersistence` | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã®åˆæœŸåŒ– | O(1) | O(1) |
| IndexPersistence::exists | æ¨å®š: `fn exists(&self) -> bool` | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å­˜åœ¨åˆ¤å®š | O(1)ã€œO(k)ï¼ˆãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«æ•°/FSä¾å­˜ï¼‰ | O(1) |
| init::resolve_index_path | æ¨å®š: `fn resolve_index_path(settings: &Settings, config_path: Option<&Path>) -> PathBuf` | `index_path` ã®åŸºæº–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åŸºã¥ãæ­£ã—ã„çµ¶å¯¾/ç›¸å¯¾è§£æ±º | O(1) | O(1) |

è©³ç´°èª¬æ˜ï¼ˆæ¨å®šãƒ™ãƒ¼ã‚¹ï¼‰

1) Settings::load_from
- ç›®çš„ã¨è²¬å‹™
  - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆTOMLãªã©ï¼‰ã‹ã‚‰ `Settings` ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚ç›¸å¯¾ `index_path` ã¯ãã®ã¾ã¾ä¿æŒã•ã‚Œã‚‹ã€‚
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆæ¨å®šï¼‰
  - ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ â†’ ãƒ‘ãƒ¼ã‚¹ â†’ æ§‹é€ ä½“ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸è¨­å®š
- å¼•æ•°

| åç§° | å‹ | å¿…é ˆ | èª¬æ˜ |
|-----|----|------|------|
| path | &Path | å¿…é ˆ | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ |

- æˆ»ã‚Šå€¤

| å‹ | èª¬æ˜ |
|----|------|
| Result<Settings, E> | æˆåŠŸã§ `Settings`ã€å¤±æ•—ã§ã‚¨ãƒ©ãƒ¼ |

- ä½¿ç”¨ä¾‹ï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«æŠœç²‹ï¼‰

```rust
// L48-L49
let settings = Settings::load_from(&settings_path).expect("Should load settings");
```

- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
  - ãƒ•ã‚¡ã‚¤ãƒ«ä¸å­˜åœ¨ã€ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã€æ¨©é™ä¸è¶³

2) IndexPersistence::new / exists
- ç›®çš„ã¨è²¬å‹™
  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚„ã‚¢ã‚¯ã‚»ã‚¹ã®ãŸã‚ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’ç”Ÿæˆã—ã€å­˜åœ¨ç¢ºèªã‚’æä¾›ã€‚
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆæ¨å®šï¼‰
  - `new`: ãƒ‘ã‚¹ã‚’ä¿æŒ
  - `exists`: å¿…é ˆãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹: semantic/metadata.json, tantivy/meta.jsonï¼‰ã®å­˜åœ¨ã‚’ç¢ºèª
- å¼•æ•°/æˆ»ã‚Šå€¤ï¼ˆæ¨å®šï¼‰

| åç§° | å‹ | å¿…é ˆ | èª¬æ˜ |
|-----|----|------|------|
| index_path | PathBuf | å¿…é ˆ | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒ‘ã‚¹ |

| æˆ»ã‚Šå€¤ | èª¬æ˜ |
|--------|------|
| IndexPersistence | ãƒãƒ³ãƒ‰ãƒ© |
| boolï¼ˆexistsï¼‰ | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå­˜åœ¨ã™ã‚Œã°true |

- ä½¿ç”¨ä¾‹ï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«æŠœç²‹ãƒ»èª¤/æ­£ã®æ¯”è¼ƒï¼‰

```rust
// èª¤ã£ãŸç›¸å¯¾ãƒ‘ã‚¹åŸºæº–ã®æ¤œè¨¼ï¼ˆL56-L60ï¼‰
let wrong_persistence = IndexPersistence::new(settings.index_path.clone());
assert!(
    !wrong_persistence.exists(),
    "Should not find index at relative path from temp dir"
);

// resolveå¾Œã®æ­£ã—ã„ãƒ‘ã‚¹ã§ã®æ¤œè¨¼ï¼ˆL69-L73ï¼‰
let correct_persistence = IndexPersistence::new(resolved_path);
assert!(
    correct_persistence.exists(),
    "Should find index at correct resolved path"
);
```

- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
  - ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸€éƒ¨æ¬ æã€æ¨©é™ä¸è¶³ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯FSãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼ˆNASç­‰ï¼‰

3) init::resolve_index_path
- ç›®çš„ã¨è²¬å‹™
  - `Settings` å†…ã® `index_path` ãŒç›¸å¯¾ã®å ´åˆã€CWDã§ã¯ãªãè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆã¾ãŸã¯ `workspace_root`ï¼‰ã‚’åŸºæº–ã«è§£æ±ºã€‚
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆæ¨å®šï¼‰
  - `workspace_root` ãŒ Some â†’ ãã‚Œã‚’åŸºæº–ã«è§£æ±º
  - `workspace_root` ãŒ None ã‹ã¤ `config_path` ãŒ Some â†’ `config_path.parent()` ã‚’åŸºæº–ã«è§£æ±º
  - ãã‚Œã‚‰ãŒãªã‘ã‚Œã°CWDåŸºæº–ï¼ˆæ¨å®šï¼‰
- å¼•æ•°/æˆ»ã‚Šå€¤

| åç§° | å‹ | å¿…é ˆ | èª¬æ˜ |
|-----|----|------|------|
| settings | &Settings | å¿…é ˆ | index_pathã‚„workspace_rootæƒ…å ± |
| config_path | Option<&Path> | ä»»æ„ | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ |

| æˆ»ã‚Šå€¤ | èª¬æ˜ |
|--------|------|
| PathBuf | è§£æ±ºæ¸ˆã¿ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‘ã‚¹ |

- ä½¿ç”¨ä¾‹ï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«æŠœç²‹ï¼‰

```rust
// L62-L66
let resolved_path = codanna::init::resolve_index_path(&settings, Some(&settings_path));
assert_eq!(resolved_path, project_dir.join(".codanna/index"));
```

- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
  - `config_path = None`ã€`workspace_root = Some` ã¨ `index_path` ã®çµ„åˆã›
  - `index_path` ãŒçµ¶å¯¾ãƒ‘ã‚¹

## Walkthrough & Data Flow

ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ã®å‡¦ç†ã¨ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œï¼ˆçµµæ–‡å­—ã¯å½¹å‰²ã®è¦–èªæ€§å‘ä¸Šã®ãŸã‚ï¼‰:

1. ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç”Ÿæˆï¼ˆL13ï¼‰ã¨ç¾åœ¨CWDå–å¾—ï¼ˆL14ï¼‰ğŸ§ª
   - TempDir: OSå´ã«ãƒ†ã‚¹ãƒˆç”¨ã®éš”é›¢é ˜åŸŸãŒä½œæˆã•ã‚Œã‚‹ã€‚
   - original_dir: ãƒ†ã‚¹ãƒˆçµ‚äº†æ™‚ã®CWDå¾©å…ƒç”¨ã€‚

2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ“¬ä¼¼æ§‹é€ ã®ä½œæˆï¼ˆL17-L24ï¼‰ğŸ“
   - `project_dir/.codanna/index/semantic` ã¨ `tantivy` ã‚’ä½œæˆã€‚
   - ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« `semantic/metadata.json`ï¼ˆL37-L39ï¼‰ã¨ `tantivy/meta.json`ï¼ˆL41-L43ï¼‰ã‚’ç”Ÿæˆã€‚

3. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« `settings.toml` ã‚’ `project_dir/.codanna/` ã«ä½œæˆï¼ˆL27-L35ï¼‰ğŸ“
   - `index_path = ".codanna/index"` ã¨è¨˜è¿°ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ï¼‰ã€‚

4. CWD ã‚’ `temp_dir`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¤–ï¼‰ã«å¤‰æ›´ï¼ˆL46ï¼‰ğŸ”€
   - `--config` ã‚’å¤–éƒ¨ã‹ã‚‰æŒ‡å®šã—ãŸçŠ¶æ³ã‚’æ¨¡æ“¬ã€‚

5. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ï¼ˆL49ï¼‰âš™ï¸
   - `Settings::load_from(&settings_path)`ã€‚`settings.index_path` ã¯ç›¸å¯¾ãƒ‘ã‚¹ã®ã¾ã¾ä¿æŒã€‚
   - æ¤œè¨¼: `settings.workspace_root.is_none()`ï¼ˆL52-L53ï¼‰ã€‚

6. ç›¸å¯¾ãƒ‘ã‚¹ã®ã¾ã¾ `IndexPersistence` ã‚’ä½œæˆã—ã¦å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆL56-L60ï¼‰âŒ
   - CWD åŸºæº–ã®ãŸã‚èª¤ã£ãŸå ´æ‰€ã‚’è¦‹ã«è¡Œãã€å­˜åœ¨ã—ãªã„ã€‚

7. `resolve_index_path` ã«ã‚ˆã‚Šæ­£ã—ãè§£æ±ºï¼ˆL62-L66ï¼‰âœ…
   - åŸºæº–ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆ`settings_path.parent()`ï¼‰ã¨ã™ã‚‹ã“ã¨ã§ã€`project_dir/.codanna/index` ã«è§£æ±ºã€‚

8. æ­£ã—ã„ãƒ‘ã‚¹ã§ `IndexPersistence` ã‚’å†åº¦ç¢ºèªï¼ˆL69-L73ï¼‰ğŸ“
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

9. CWD ã‚’å…ƒã«æˆ»ã—ã¦ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼ˆL76ï¼‰â†©ï¸

é‡è¦ç®‡æ‰€ã®æ ¹æ‹ :
- ç›¸å¯¾ãƒ‘ã‚¹æ¤œè¨¼: L52-L53
- èª¤ã£ãŸå­˜åœ¨åˆ¤å®š: L56-L60
- è§£æ±ºå‘¼ã³å‡ºã—: L63
- æ­£ã—ã„å­˜åœ¨åˆ¤å®š: L69-L73

æŠœç²‹ã‚³ãƒ¼ãƒ‰ï¼ˆè¦ç‚¹ã®ã¿ï¼‰

```rust
// ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
let project_dir = temp_dir.path().join("my_project");
let codanna_dir = project_dir.join(".codanna");
let index_dir = codanna_dir.join("index");
let semantic_dir = index_dir.join("semantic");
let tantivy_dir = index_dir.join("tantivy");
std::fs::create_dir_all(&semantic_dir).unwrap();
std::fs::create_dir_all(&tantivy_dir).unwrap();

let settings_path = codanna_dir.join("settings.toml");
let settings_content = r#"
version = 1
index_path = ".codanna/index"

[semantic_search]
enabled = true
"#;
std::fs::write(&settings_path, settings_content).unwrap();

// CWD ã‚’å¤–éƒ¨ã«å¤‰æ›´ã—ã€è¨­å®šèª­è¾¼
std::env::set_current_dir(&temp_dir).unwrap();
let settings = Settings::load_from(&settings_path).expect("Should load settings");
assert_eq!(settings.index_path, PathBuf::from(".codanna/index"));
assert!(settings.workspace_root.is_none());

// èª¤ã£ãŸç›¸å¯¾ãƒ‘ã‚¹åŸºæº–ã§ã¯è¦‹ã¤ã‹ã‚‰ãªã„
let wrong_persistence = IndexPersistence::new(settings.index_path.clone());
assert!(!wrong_persistence.exists());

// resolve ã«ã‚ˆã‚Šæ­£ã—ã„ãƒ‘ã‚¹ã¸
let resolved_path = codanna::init::resolve_index_path(&settings, Some(&settings_path));
assert_eq!(resolved_path, project_dir.join(".codanna/index"));

let correct_persistence = IndexPersistence::new(resolved_path);
assert!(correct_persistence.exists());

// CWD å¾©å…ƒ
std::env::set_current_dir(original_dir).unwrap();
```

## Complexity & Performance

- è¨ˆç®—é‡
  - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆãƒ»ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãƒ»å­˜åœ¨ç¢ºèªãªã©ã€å›æ•°å›ºå®šã®I/Oä¸­å¿ƒã€‚æ™‚é–“ãƒ»ç©ºé–“ã¨ã‚‚ã«æ¦‚ã­**O(1)**ï¼ˆãŸã ã—I/Oãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã«ä¾å­˜ï¼‰ã€‚
  - `Settings::load_from`: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º n ã«å¯¾ã—ã¦ **O(n)** ã®èª­ã¿å–ã‚Šãƒ»ãƒ‘ãƒ¼ã‚¹ã€‚
  - `IndexPersistence::exists`: å®Ÿè£…ä¸æ˜ã ãŒã€å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¯é€šå¸¸**O(1)**ã€œ**O(k)**ï¼ˆå¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«æ•°ï¼‰ç¨‹åº¦ã€‚

- ãƒœãƒˆãƒ«ãƒãƒƒã‚¯/ã‚¹ã‚±ãƒ¼ãƒ«é™ç•Œ
  - FSæ“ä½œï¼ˆ`create_dir_all`, `write`, `exists`ï¼‰ãŒæ”¯é…çš„ã€‚ç‰¹ã«ä½é€Ÿã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯FSã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å¢—ã€‚
  - CWDå¤‰æ›´ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã®ãŸã‚ã€ä¸¦è¡Œãƒ†ã‚¹ãƒˆæ™‚ã«**å¾…ã¡åˆã‚ã›**ã‚„**ç«¶åˆ**ãŒç”Ÿã˜å¾—ã‚‹ã€‚

- å®Ÿé‹ç”¨è² è·è¦å› 
  - ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ†ã‚¹ãƒˆã®ã¿ã ãŒã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å´ã® `exists` å®Ÿè£…ã¯FSã‚¢ã‚¯ã‚»ã‚¹å›æ•°ã‚„ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«ä¾å­˜ã€‚
  - Windows ã¨ Unix ç³» OS ã®ãƒ‘ã‚¹è¡¨ç¾å·®ç•°ï¼ˆ`".codanna/index"` ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥è¡¨è¨˜ï¼‰ã¯äº’æ›æ€§ã«ç•™æ„ã€‚

## Edge Cases, Bugs, and Security

- ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§
  - Rustã®æ‰€æœ‰æ¨©ãƒ»å€Ÿç”¨ã«ã‚ˆã‚Šå®‰å…¨ã€‚`TempDir` ã¨ `PathBuf` ã¯ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ç®¡ç†ãŒè‡ªå‹•ã€‚`unsafe` ä¸ä½¿ç”¨ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰ã€‚
  - `unwrap`/`expect` ã¯ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã¨**panic**ã™ã‚‹ãŒã€ãƒ†ã‚¹ãƒˆã§è¨±å®¹ã•ã‚Œã‚‹ã€‚

- ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
  - å…¥åŠ›ã¯ãƒ†ã‚¹ãƒˆã§ç”Ÿæˆã—ãŸå›ºå®šæ–‡å­—åˆ—ãƒ»ãƒ‘ã‚¹ã®ã¿ã€‚SQL/Command/Path traversal ã®æ‡¸å¿µã¯ä½ã„ã€‚

- èªè¨¼ãƒ»èªå¯
  - è©²å½“ãªã—ã€‚

- ç§˜å¯†æƒ…å ±
  - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç§˜å¯†ã‚„ãƒ­ã‚°æ¼ãˆã„ãªã—ã€‚

- ä¸¦è¡Œæ€§
  - é‡å¤§ãƒªã‚¹ã‚¯: `std::env::set_current_dir` ã¯ãƒ—ãƒ­ã‚»ã‚¹ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§**ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã¯ãªã„**ã€‚ä¸¦è¡Œãƒ†ã‚¹ãƒˆæ™‚ã«ä»–ã‚¹ãƒ¬ãƒƒãƒ‰/ãƒ†ã‚¹ãƒˆã¸å½±éŸ¿ã—**ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³**ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ï¼ˆL46, L76ï¼‰ã€‚ã“ã®ãƒ†ã‚¹ãƒˆã¯**ã‚·ãƒªã‚¢ãƒ«å®Ÿè¡Œ**ãŒæœ›ã¾ã—ã„ã€‚
  - ãƒ†ã‚¹ãƒˆå†…ã§ã¯å…±æœ‰çŠ¶æ…‹ã‚’ä¿è­·ã™ã‚‹åŒæœŸåŒ–ã¯ãªã—ï¼ˆå¿…è¦æ€§ã¯ä¸Šè¨˜ã®é€šã‚Šã‚°ãƒ­ãƒ¼ãƒãƒ«CWDå¤‰æ›´ã«èµ·å› ï¼‰ã€‚

- ã‚¨ãƒ©ãƒ¼è¨­è¨ˆ
  - `unwrap` ã¨ `expect` ã‚’å¤šç”¨ï¼ˆL13, L14, L23, L24, L35, L39, L43, L46, L49, L76ï¼‰ã€‚ãƒ†ã‚¹ãƒˆã§ã¯ç°¡æ½”ã ãŒã€é€”ä¸­ã§panicã™ã‚‹ã¨CWDå¾©å…ƒãŒå®Ÿè¡Œã•ã‚Œãš**å¾Œç¶šãƒ†ã‚¹ãƒˆã«å½±éŸ¿**ã—å¾—ã‚‹ã€‚

Edge Cases è©³ç´°è¡¨

| ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ | å…¥åŠ›ä¾‹ | æœŸå¾…å‹•ä½œ | å®Ÿè£… | çŠ¶æ…‹ |
|-------------|--------|----------|------|------|
| CWDæœªå¾©å…ƒã§panic | ãƒ•ã‚¡ã‚¤ãƒ«I/Oå¤±æ•— â†’ `unwrap`ã§panic | CWDå¾©å…ƒã•ã‚Œãšå¾Œç¶šãƒ†ã‚¹ãƒˆã«å½±éŸ¿ â†’ Guardã§ç¢ºå®Ÿã«å¾©å…ƒ | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ | èª²é¡Œã‚ã‚Š |
| ä¸¦è¡Œãƒ†ã‚¹ãƒˆã§CWDç«¶åˆ | ä»–ãƒ†ã‚¹ãƒˆã‚‚`set_current_dir`ä½¿ç”¨ | ãƒ†ã‚¹ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ«åŒ–ã™ã‚‹/ã‚¬ãƒ¼ãƒ‰ã§å±€æ‰€åŒ– | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ | èª²é¡Œã‚ã‚Š |
| config_path=None | `resolve_index_path(&settings, None)` | CWDåŸºæº–/ã‚¨ãƒ©ãƒ¼/ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã„ãšã‚Œã‹ã«æ±ºå®š | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ | ä¸æ˜ |
| workspace_root=Some | `settings.workspace_root = Some(project_dir)` | workspace_rootåŸºæº–ã§è§£æ±º | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ | ä¸æ˜ |
| index_pathãŒçµ¶å¯¾ | `"/abs/.codanna/index"` | ãã®ã¾ã¾ä½¿ç”¨ï¼ˆè§£æ±ºä¸è¦ï¼‰ | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ | ä¸æ˜ |
| ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«æ¬ æ | `semantic/metadata.json`ãªã— | `exists()`ã¯false | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ | ä¸æ˜ |
| ãƒ‘ã‚¹ã«ä¸å¯è¦–æ–‡å­— | `" .codanna/index"` ãªã© | æ­£è¦åŒ–/ãƒˆãƒªãƒ ã®æ‰±ã„ | ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ | ä¸æ˜ |

æ ¹æ‹ ï¼ˆè¡Œç•ªå·ä¾‹ï¼‰
- CWDå¤‰æ›´: L46, å¾©å…ƒ: L76
- ç›¸å¯¾ãƒ‘ã‚¹æ¤œè¨¼: L52-L53
- èª¤ãƒ»æ­£ã®å­˜åœ¨åˆ¤å®š: L56-L60, L69-L73

## Design & Architecture Suggestions

- ã‚°ãƒ­ãƒ¼ãƒãƒ«CWDå¤‰æ›´ã®æ’é™¤/ã‚¬ãƒ¼ãƒ‰åŒ–
  - RAIIã‚¬ãƒ¼ãƒ‰ï¼ˆä¾‹: ç‹¬è‡ªã® `WorkingDirGuard`ï¼‰ã§CWDå¾©å…ƒã‚’**ç¢ºå®ŸåŒ–**ã€‚panicæ™‚ã§ã‚‚å¾©å…ƒã•ã‚Œã€å¾Œç¶šãƒ†ã‚¹ãƒˆã¸ã®æ‚ªå½±éŸ¿ã‚’é˜²æ­¢ã€‚
  - ä»£æ›¿ã¨ã—ã¦ã€`resolve_index_path` ã‚’ç”¨ã„ã¦**å¸¸ã«çµ¶å¯¾ãƒ‘ã‚¹**ã¸è§£æ±ºã—ã€CWDã«ä¾å­˜ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã‹ã‚‰æ’é™¤ã€‚

- `resolve_index_path` ã®è¨­è¨ˆ
  - å„ªå…ˆé †: `workspace_root` â†’ `config_path.parent()` â†’ CWDã€‚
  - ãƒ‘ã‚¹æ­£è¦åŒ–ï¼ˆ`canonicalize`ï¼‰ã¨**ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ äº’æ›æ€§**ã®ç¢ºä¿ã€‚
  - ãƒ­ã‚°å‡ºåŠ›: ã©ã®åŸºæº–ã‚’ä½¿ç”¨ã—ãŸã‹ã€ç›¸å¯¾â†’çµ¶å¯¾ã®å¤‰æ›çµæœã‚’**debug**ãƒ­ã‚°ã§è¨˜éŒ²ã€‚

- `IndexPersistence::exists`
  - ä¾å­˜ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å®šç¾©ã‚’æ˜ç¢ºåŒ–ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ï¼‰ã€‚å­˜åœ¨åˆ¤å®šã®**æ¡ä»¶**ã‚’ãƒ†ã‚¹ãƒˆã§ç¶²ç¾…å¯èƒ½ã«ã€‚

## Testing Strategy (Unit/Integration) with Examples

- ã‚·ãƒªã‚¢ãƒ«å®Ÿè¡Œã®ç¢ºä¿
  - Cargo: `cargo test -- --test-threads=1` ã¾ãŸã¯ `serial_test` ã‚¯ãƒ¬ãƒ¼ãƒˆåˆ©ç”¨ã§ãƒ†ã‚¹ãƒˆã®ä¸¦è¡Œå®Ÿè¡Œã‚’åœæ­¢ã€‚

- è¿½åŠ ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
  1) `workspace_root` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ç›¸å¯¾è§£æ±º
```rust
#[test]
fn test_resolve_with_workspace_root() {
    // æº–å‚™ã¯çœç•¥...
    let mut settings = Settings::load_from(&settings_path).unwrap();
    settings.workspace_root = Some(project_dir.clone()); // æ¨å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    let resolved = codanna::init::resolve_index_path(&settings, Some(&settings_path));
    assert_eq!(resolved, project_dir.join(".codanna/index"));
}
```

  2) çµ¶å¯¾ãƒ‘ã‚¹æŒ‡å®šã®ç¶­æŒ
```rust
#[test]
fn test_absolute_index_path_unchanged() {
    // æº–å‚™ã¯çœç•¥...
    let mut settings = Settings::load_from(&settings_path).unwrap();
    settings.index_path = PathBuf::from(project_dir.join(".codanna/index")); // çµ¶å¯¾ã«è¨­å®š
    let resolved = codanna::init::resolve_index_path(&settings, Some(&settings_path));
    assert_eq!(resolved, settings.index_path); // å¤‰æ›´ãªã—
}
```

  3) `config_path=None` ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æŒ™å‹•
```rust
#[test]
fn test_resolve_without_config_path() {
    // æº–å‚™ã¯çœç•¥...
    let settings = Settings::load_from(&settings_path).unwrap();
    let resolved = codanna::init::resolve_index_path(&settings, None);
    // æœŸå¾…ã¯ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆä»•æ§˜ã«å¾“ã†ï¼ˆCWDåŸºæº– or ã‚¨ãƒ©ãƒ¼ï¼‰ã€‚ã“ã“ã¯ä¸æ˜ã®ãŸã‚ä»®æ–­è¨€ã¯é¿ã‘ã‚‹ã€‚
    // assert_eq!(...);
}
```

  4) ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä¸å®Œå…¨ãªå ´åˆã®å­˜åœ¨åˆ¤å®š
```rust
#[test]
fn test_index_exists_with_missing_metadata() {
    // semanticã®metadata.jsonã‚’ä½œã‚‰ãªã„
    // tantivyã®meta.jsonã®ã¿ä½œã‚‹
    // ...
    let p = IndexPersistence::new(project_dir.join(".codanna/index"));
    assert!(!p.exists(), "ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«æ¬ æãªã‚‰existsã¯falseã®ã¯ãšï¼ˆä»•æ§˜è¦ç¢ºèªï¼‰");
}
```

- ãƒ­ã‚°ã®æ¤œè¨¼
  - `resolve_index_path` ã®ãƒ­ã‚°ã‚’ `tracing` ã§å‡ºã—ã€ãƒ†ã‚¹ãƒˆã§ `tracing_subscriber` ã«ã‚ˆã‚Šã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦æ­£ã—ã„åŸºæº–ãŒé¸æŠã•ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼ã€‚

## Refactoring Plan & Best Practices

- CWDã‚¬ãƒ¼ãƒ‰å°å…¥
  - ä¾‹: ã‚¹ã‚³ãƒ¼ãƒ—çµ‚äº†æ™‚ã«å…ƒã®CWDã¸æˆ»ã™å‹ã‚’ç”¨æ„ã—ã€`set_current_dir` ã®å‘¼ã³å‡ºã—ã‚’ãƒ©ãƒƒãƒ—ã€‚

```rust
struct CwdGuard(PathBuf);
impl CwdGuard {
    fn change_to<P: AsRef<std::path::Path>>(p: P) -> std::io::Result<Self> {
        let original = std::env::current_dir()?;
        std::env::set_current_dir(p)?;
        Ok(CwdGuard(original))
    }
}
impl Drop for CwdGuard {
    fn drop(&mut self) {
        let _ = std::env::set_current_dir(&self.0);
    }
}
```

- ãƒ†ã‚¹ãƒˆã®æ˜ç¢ºåŒ–
  - `unwrap`/`expect` ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’**çŠ¶æ³ä¾å­˜**ã§å…·ä½“åŒ–ã€‚
  - ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—/ãƒ†ã‚£ã‚¢ãƒ€ã‚¦ãƒ³ã‚’é–¢æ•°åŒ–ã—ã¦é‡è¤‡æ’é™¤ã€‚

- ãƒ‘ã‚¹ã®æ­£è¦åŒ–/æ¯”è¼ƒ
  - æœŸå¾…å€¤æ¯”è¼ƒã§ã¯ `canonicalize()` ã‚’ä½¿ã„ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å·®ç•°ã‚’å¸åã€‚

- çµ¶å¯¾ãƒ‘ã‚¹åŒ–ã®å¾¹åº•
  - ãƒ†ã‚¹ãƒˆå†…ãƒ»æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã¨ã‚‚ã« `resolve_index_path` ã‚’é€šã—ã¦**çµ¶å¯¾ãƒ‘ã‚¹**ã«çµ±ä¸€ã™ã‚‹æ–¹é‡ã€‚

## Observability (Logging, Metrics, Tracing)

- æ¨å¥¨ãƒ­ã‚°ãƒã‚¤ãƒ³ãƒˆï¼ˆ`resolve_index_path` å´ï¼‰
  - é¸æŠã•ã‚ŒãŸåŸºæº–ï¼ˆworkspace_root/config_path/CWDï¼‰
  - å…¥åŠ›ã® `index_path` ã¨å‡ºåŠ›ã®è§£æ±ºçµæœ
  - ç›¸å¯¾â†’çµ¶å¯¾å¤‰æ›ã®è©³ç´°ï¼ˆ`canonicalize` ã®æˆå¦ï¼‰

- ãƒ†ã‚¹ãƒˆã§ã®ãƒ­ã‚°æ¤œè¨¼
  - `tracing_subscriber` ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã€`resolve_index_path` ã®ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£â†’ã‚¢ã‚µãƒ¼ãƒˆã€‚

- ãƒ¡ãƒˆãƒªã‚¯ã‚¹/ãƒˆãƒ¬ãƒ¼ã‚¹
  - ãƒ†ã‚¹ãƒˆã§ã¯ä¸è¦ã ãŒã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§FSã‚¢ã‚¯ã‚»ã‚¹å›æ•°ãƒ»ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡ã‚’ãƒ¡ãƒˆãƒªã‚¯ã‚¹åŒ–ã™ã‚‹ã¨å•é¡Œè¨ºæ–­ãŒå®¹æ˜“ã€‚

## Risks & Unknowns

- ä¸æ˜ç‚¹
  - `Settings` æ§‹é€ ä½“ã®æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä»•æ§˜ï¼ˆ`workspace_root` ã®å®šç¾©/å‹ï¼‰ã¨ `resolve_index_path` ã®å³å¯†ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ã€‚
  - `IndexPersistence::exists` ã®å­˜åœ¨åˆ¤å®šæ¡ä»¶ï¼ˆå¿…è¦ãƒ¡ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®åˆ¥/æ•°ï¼‰ã¯ä¸æ˜ã€‚

- ãƒªã‚¹ã‚¯
  - ã‚°ãƒ­ãƒ¼ãƒãƒ«CWDå¤‰æ›´ã«ã‚ˆã‚‹ä¸¦è¡Œãƒ†ã‚¹ãƒˆã®ä¸å®‰å®šåŒ–ã€‚
  - Windows/Unix é–“ã®ãƒ‘ã‚¹åŒºåˆ‡ã‚Šãƒ»ãƒªãƒ³ã‚¯ãƒ»æ¨©é™å·®ç•°ã«ã‚ˆã‚‹FSæ“ä½œå¤±æ•—ã€‚
  - ä¾‹å¤–çš„ãªFSç’°å¢ƒï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‰ãƒ©ã‚¤ãƒ–ã€èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ã§ã®I/Oã‚¨ãƒ©ãƒ¼ã€‚

- ç·©å’Œç­–
  - ã‚·ãƒªã‚¢ãƒ«å®Ÿè¡Œã€CWDã‚¬ãƒ¼ãƒ‰ã€çµ¶å¯¾ãƒ‘ã‚¹åŒ–ã®å¾¹åº•ã€‚
  - ãƒ‘ã‚¹æ­£è¦åŒ–ã¨è©³ç´°ãƒ­ã‚°ã«ã‚ˆã‚Šä¸å…·åˆã®æ—©æœŸæ¤œçŸ¥ã€‚