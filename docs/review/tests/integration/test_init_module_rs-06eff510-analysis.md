# integration\test_init_module.rs Review

## TL;DR

- âœ… ç›®çš„: **init::init_global_dirs() ãŒãƒ¢ãƒ‡ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹**ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹å˜ä¸€ã®çµ±åˆãƒ†ã‚¹ãƒˆ
- ğŸ” ä½¿ç”¨API: å¤–éƒ¨ã® **codanna::init::init_global_dirs()** ã¨ **codanna::init::models_dir()** ã‚’å‘¼ã³å‡ºã—ã¦çµæœã‚’ç¢ºèªï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯å®šç¾©ãªã—ï¼‰
- âš ï¸ é‡å¤§ãƒªã‚¹ã‚¯: ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒå¤‰æ•° **HOME** ã‚’ãƒ†ã‚¹ãƒˆä¸­ã«å¤‰æ›´ã—ã¦ãŠã‚Šã€ä¸¦è¡Œå®Ÿè¡Œæ™‚ã«ä»–ãƒ†ã‚¹ãƒˆã¸å‰¯ä½œç”¨ï¼ˆãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ï¼‰ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§
- ğŸ§¯ èª¤ç”¨: **unsafe** ãƒ–ãƒ­ãƒƒã‚¯ã§ `std::env::set_var`/`remove_var` ã‚’å›²ã£ã¦ã„ã‚‹ãŒã€ã“ã‚Œã‚‰ã¯å®‰å…¨é–¢æ•°ã§ã‚ã‚Š *unsafeä¸è¦*
- ğŸ§ª æ¤œè¨¼ä¸è¶³: ä½œæˆå ´æ‰€ãŒæœ¬å½“ã«ãƒ†ãƒ³ãƒãƒ©ãƒªé…ä¸‹ã‹ã®ç¢ºèªãŒãªãã€èª¤ã£ã¦å®Ÿãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”Ÿæˆã—ã¦ã‚‚è¦‹é€ƒã™å¯èƒ½æ€§
- ğŸ–¥ï¸ äº’æ›æ€§: Windowsã‚„XDGç’°å¢ƒã§**HOME**ãŒå‚ç…§ã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã€ãƒ†ã‚¹ãƒˆã®æ„å›³ã¨å®Ÿè£…ãŒã‚ºãƒ¬ã‚‹ãƒªã‚¹ã‚¯

## Overview & Purpose

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ Rust ã®çµ±åˆãƒ†ã‚¹ãƒˆã§ã€`codanna::init` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆæœŸåŒ–å‡¦ç†ãŒã€Œãƒ¢ãƒ‡ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã¯ä¸€ã¤ã®ã¿ã§ã€å®Ÿè¡Œä¸­ã¯ `HOME` ç’°å¢ƒå¤‰æ•°ã‚’ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å·®ã—æ›¿ãˆã€çµ‚äº†æ™‚ã«å…ƒã¸å¾©å…ƒã—ã¾ã™ã€‚

ä¸»ãªæ¤œè¨¼é …ç›®:
- `init::init_global_dirs()` ãŒæˆåŠŸã‚’è¿”ã™ã“ã¨
- `init::models_dir()` ãŒå­˜åœ¨ã—ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã‚ã‚‹ã“ã¨

ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ `codanna::init` ã®å®Ÿè£…ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

## Structure & Key Components

| ç¨®åˆ¥ | åå‰ | å…¬é–‹ç¯„å›² | è²¬å‹™ | è¤‡é›‘åº¦ |
|------|------|----------|------|--------|
| Function | test_init_creates_models_directory | privateï¼ˆãƒ†ã‚¹ãƒˆï¼‰ | `HOME` ã‚’ãƒ†ãƒ³ãƒãƒ©ãƒªã«å¤‰æ›´ã—ã¦ `init_global_dirs` ã‚’å‘¼ã³ã€`models_dir` ã®å­˜åœ¨ã‚’æ¤œè¨¼ | Low |

### Dependencies & Interactions

- å†…éƒ¨ä¾å­˜ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®å‘¼ã³å‡ºã—é–¢ä¿‚ï¼‰
  - è©²å½“ãªã—ï¼ˆå˜ä¸€ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ã¿ï¼‰
- å¤–éƒ¨ä¾å­˜ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒˆãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
  | ä¾å­˜ | ç”¨é€” |
  |------|------|
  | codanna::init | `init_global_dirs()` å‘¼ã³å‡ºã—ã¨ `models_dir()` å–å¾— |
  | std::env | `HOME` ç’°å¢ƒå¤‰æ•°ã®å–å¾—ãƒ»è¨­å®šãƒ»å‰Šé™¤ |
  | tempfile::TempDir | ãƒ†ã‚¹ãƒˆç”¨ã®ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— |
- è¢«ä¾å­˜æ¨å®šï¼ˆã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ç®‡æ‰€ï¼‰
  - çµ±åˆãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ï¼ˆ`cargo test` ã®ä¸€éƒ¨ã¨ã—ã¦å®Ÿè¡Œï¼‰
  - ä»–ã®çµ±åˆãƒ†ã‚¹ãƒˆã¨ãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã€ä¸¦è¡Œã«å®Ÿè¡Œã•ã‚Œã‚‹ä»–ãƒ†ã‚¹ãƒˆã¸å½±éŸ¿ã—ã†ã‚‹

## API Surface (Public/Exported) and Data Contracts

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã«å…¬é–‹APIã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä½¿ç”¨ã—ã¦ã„ã‚‹å¤–éƒ¨APIã‚’å«ã‚ã¦ä¸€è¦§ã—ã¾ã™ï¼ˆã‚·ã‚°ãƒãƒãƒ£ã¯ä¸€éƒ¨æ¨å®šãƒ»ä¸æ˜ï¼‰ã€‚

| APIå | ã‚·ã‚°ãƒãƒãƒ£ | ç›®çš„ | Time | Space |
|-------|-----------|------|------|-------|
| test_init_creates_models_directory | `fn test_init_creates_models_directory()` | çµ±åˆãƒ†ã‚¹ãƒˆæœ¬ä½“ | O(1) | O(1) |
| init::init_global_dirs | `fn init_global_dirs() -> Result<_, _>`ï¼ˆä¸æ˜ï¼‰ | ã‚°ãƒ­ãƒ¼ãƒãƒ«å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ | O(1) | O(1) |
| init::models_dir | `fn models_dir() -> PathBuf`ï¼ˆæ¨å®šï¼‰ | ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹å–å¾— | O(1) | O(1) |

è©³ç´°:

1) test_init_creates_models_directory
- ç›®çš„ã¨è²¬å‹™
  - ãƒ†ã‚¹ãƒˆä¸­ã®ã¿ `HOME` ã‚’ä¸€æ™‚çš„ã«å·®ã—æ›¿ãˆãŸã†ãˆã§åˆæœŸåŒ–å‡¦ç†ã‚’å‘¼ã³ã€ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã™ã‚‹
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆã‚¹ãƒ†ãƒƒãƒ—åˆ†è§£ï¼‰
  1. `TempDir::new()` ã§ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
  2. å…ƒã® `HOME` ã‚’ `env::var("HOME").ok()` ã§é€€é¿
  3. `env::set_var("HOME", temp_dir.path())` ã§ `HOME` ã‚’ç½®ãæ›ãˆ
  4. `init::init_global_dirs()` ã‚’å‘¼ã³ã€`is_ok()` ã‚’ç¢ºèª
  5. `init::models_dir()` ã‚’å–å¾—ã—ã€`exists()` ã¨ `is_dir()` ã‚’ç¢ºèª
  6. é€€é¿ã—ãŸ `HOME` ã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯å‰Šé™¤ï¼‰
- å¼•æ•°
  | å¼•æ•°å | å‹ | å—ã‘æ¸¡ã— | èª¬æ˜ |
  |--------|----|----------|------|
  | ãªã— | - | - | ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ãŸã‚å¼•æ•°ãªã— |
- æˆ»ã‚Šå€¤
  | å‹ | èª¬æ˜ |
  |----|------|
  | `()` | ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ãŸã‚å€¤ã¯è¿”ã•ãšã€ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—ã§ãƒ‘ãƒ‹ãƒƒã‚¯ |
- ä½¿ç”¨ä¾‹
  ```rust
  #[test]
  fn test_init_creates_models_directory() {
      let temp_dir = tempfile::TempDir::new().expect("Failed to create temp dir");
      let original_home = std::env::var("HOME").ok();
      std::env::set_var("HOME", temp_dir.path());

      let result = codanna::init::init_global_dirs();
      assert!(result.is_ok(), "Should create directories without error");

      let models_dir = codanna::init::models_dir();
      assert!(models_dir.exists(), "Models directory should exist");
      assert!(models_dir.is_dir(), "Should be a directory, not a file");

      if let Some(home) = original_home {
          std::env::set_var("HOME", home);
      } else {
          std::env::remove_var("HOME");
      }
  }
  ```
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
  - ä¸¦è¡Œå®Ÿè¡Œä¸­ã«ä»–ãƒ†ã‚¹ãƒˆã‚‚ `HOME` ã‚’å¤‰æ›´ã—ã¦ã„ã‚‹
  - Windows/XDG ç’°å¢ƒã§ `HOME` ãŒå‚ç…§ã•ã‚Œãªã„
  - `TempDir::new()` ãŒå¤±æ•—ï¼ˆæ¨©é™ãƒ»ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ï¼‰
  - `models_dir` ãŒãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å­˜åœ¨ã—ã¦ã—ã¾ã†ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ãªã„ï¼‰

2) init::init_global_dirsï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯å®Ÿè£…ãªã—ï¼‰
- ç›®çš„ã¨è²¬å‹™
  - å¿…è¦ãªã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã©ï¼‰ã‚’ä½œæˆã™ã‚‹
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
  - ä¸æ˜ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰
- å¼•æ•°
  | å¼•æ•°å | å‹ | èª¬æ˜ |
  |--------|----|------|
  | ãªã—ï¼ˆæ¨å®šï¼‰ | - | ä¸æ˜ |
- æˆ»ã‚Šå€¤
  | å‹ | èª¬æ˜ |
  |----|------|
  | `Result<_, _>` | æˆå¦ã®ã¿ç¢ºèªå¯èƒ½ã€‚å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼å‹ãƒ»æˆåŠŸå€¤ã¯ä¸æ˜ |
- ä½¿ç”¨ä¾‹
  ```rust
  let result = codanna::init::init_global_dirs();
  assert!(result.is_ok());
  ```
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
  - ä¸æ˜ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰

3) init::models_dirï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯å®Ÿè£…ãªã—ï¼‰
- ç›®çš„ã¨è²¬å‹™
  - ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ï¼ˆ`PathBuf` ã¨æ¨å®šï¼‰ã‚’è¿”ã™
- ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
  - ä¸æ˜ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰
- å¼•æ•°
  | å¼•æ•°å | å‹ | èª¬æ˜ |
  |--------|----|------|
  | ãªã— | - | ä¸æ˜ |
- æˆ»ã‚Šå€¤
  | å‹ | èª¬æ˜ |
  |----|------|
  | `PathBuf`ï¼ˆæ¨å®šï¼‰ | `exists()` ã¨ `is_dir()` ã‚’å‘¼ã¹ã‚‹ã“ã¨ã‹ã‚‰ãƒ‘ã‚¹å‹ã¨æ¨å®š |
- ä½¿ç”¨ä¾‹
  ```rust
  let models_dir = codanna::init::models_dir();
  assert!(models_dir.exists());
  assert!(models_dir.is_dir());
  ```
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
  - ä¸æ˜ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰

## Walkthrough & Data Flow

ãƒ†ã‚¹ãƒˆé–¢æ•°ã®ä¸»è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆI/Oä¸­å¿ƒï¼‰:

1. ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
   ```rust
   let temp_dir = TempDir::new().expect("Failed to create temp dir");
   ```
   - ä½œæˆã•ã‚ŒãŸãƒ‘ã‚¹ã¯ `temp_dir.path()` ã§å‚ç…§ï¼ˆå€Ÿç”¨ï¼‰

2. ç’°å¢ƒå¤‰æ•° `HOME` ã®é€€é¿ã¨ä¸Šæ›¸ã
   ```rust
   let original_home = env::var("HOME").ok();
   env::set_var("HOME", temp_dir.path());
   ```
   - `original_home` ã¯ `Option<String>` ã¨ã—ã¦æ‰€æœ‰
   - `set_var` ã¯å®‰å…¨é–¢æ•°ï¼ˆunsafeä¸è¦ï¼‰

3. åˆæœŸåŒ–å‡¦ç†ã®å‘¼ã³å‡ºã—ã¨çµæœç¢ºèª
   ```rust
   let result = init::init_global_dirs();
   assert!(result.is_ok(), "Should create directories without error");
   ```
   - `Result` ã®ã¿åˆ¤å®šã—ã€ã‚¨ãƒ©ãƒ¼å†…å®¹ã¯å‡ºåŠ›ã—ã¦ã„ãªã„

4. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨æ¤œè¨¼
   ```rust
   let models_dir = init::models_dir();
   assert!(models_dir.exists(), "Models directory should exist");
   assert!(models_dir.is_dir(), "Should be a directory, not a file");
   ```

5. `HOME` ã®å¾©å…ƒã¾ãŸã¯å‰Šé™¤
   ```rust
   if let Some(home) = original_home {
       env::set_var("HOME", home);
   } else {
       env::remove_var("HOME");
   }
   ```

6. `TempDir` ã®ãƒ‰ãƒ­ãƒƒãƒ—ã«ã‚ˆã‚‹è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

ã“ã®æµã‚Œã¯ç›´ç·šçš„ã§åˆ†å²ãŒå°‘ãªãã€Mermaidå›³ã®ä½¿ç”¨åŸºæº–ã«è©²å½“ã—ãªã„ãŸã‚å›³ã¯çœç•¥ã—ã¾ã™ã€‚

è©²å½“ã‚³ãƒ¼ãƒ‰ç¯„å›²: `test_init_creates_models_directory` é–¢æ•°å…¨ä½“ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ï¼‰

## Complexity & Performance

- æ™‚é–“è¨ˆç®—é‡: O(1)ï¼ˆå›ºå®šå›æ•°ã®ç’°å¢ƒå¤‰æ•°æ“ä½œã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ/ç¢ºèªï¼‰
- ç©ºé–“è¨ˆç®—é‡: O(1)
- å®Ÿé‹ç”¨è² è·è¦å› :
  - ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ I/Oï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¯é…å»¶ãƒ»æ¨©é™ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ï¼‰
  - ãƒ†ã‚¹ãƒˆã®ä¸¦è¡Œå®Ÿè¡Œæ™‚ã®ç’°å¢ƒå¤‰æ•°ã‚¢ã‚¯ã‚»ã‚¹ç«¶åˆï¼ˆã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆã«å½±éŸ¿ï¼‰

## Edge Cases, Bugs, and Security

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè©•ä¾¡:
- ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§
  - Buffer overflow / Use-after-free / Integer overflow: è©²å½“ãªã—
  - ä¸è¦ãªunsafeä½¿ç”¨: `env::set_var`/`remove_var` ã¯å®‰å…¨é–¢æ•°ã ãŒã€unsafeãƒ–ãƒ­ãƒƒã‚¯ã§å›²ã£ã¦ã„ã‚‹ï¼ˆé–¢æ•°: test_init_creates_models_directory, è¡Œ: HOMEè¨­å®šãƒ–ãƒ­ãƒƒã‚¯ã¨å¾©å…ƒãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã€‚ä¸è¦ã§ã‚ã‚Šèª¤è§£ã‚’æ‹›ãã€‚
- ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
  - SQL/Command/Path traversal: è©²å½“ãªã—ï¼ˆå›ºå®šAPIå‘¼ã³å‡ºã—ã®ã¿ï¼‰
- èªè¨¼ãƒ»èªå¯
  - è©²å½“ãªã—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«I/Oã®ã¿ï¼‰
- ç§˜å¯†æƒ…å ±
  - Hard-coded secrets / Log leakage: è©²å½“ãªã—
- ä¸¦è¡Œæ€§
  - Race condition: é«˜ãƒªã‚¹ã‚¯ã€‚`HOME` ã¯ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã®å…±æœ‰çŠ¶æ…‹ã§ã‚ã‚Šã€ä¸¦åˆ—ãƒ†ã‚¹ãƒˆã§ç«¶åˆã™ã‚‹å¯èƒ½æ€§
  - Deadlock: è©²å½“ãªã—

ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹è©³ç´°è¡¨:

| ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ | å…¥åŠ›ä¾‹ | æœŸå¾…å‹•ä½œ | å®Ÿè£… | çŠ¶æ…‹ |
|-------------|--------|----------|------|------|
| `HOME` æœªè¨­å®š | ç’°å¢ƒã« `HOME` ãŒå­˜åœ¨ã—ãªã„ | ãƒ†ã‚¹ãƒˆçµ‚äº†æ™‚ã«é©åˆ‡ã«å‰Šé™¤ | `original_home` ãŒ `None` ã®å ´åˆ `remove_var` å®Ÿè¡Œ | è‰¯å¥½ |
| `HOME` ç«¶åˆ | ä»–ãƒ†ã‚¹ãƒˆã‚‚åŒæ™‚ã« `HOME` ã‚’å¤‰æ›´ | ç«¶åˆã‚’é¿ã‘ã‚‹ï¼ˆã‚·ãƒªã‚¢ãƒ«åŒ– or ãƒ­ãƒƒã‚¯ï¼‰ | ã‚¬ãƒ¼ãƒ‰ãªã— | è¦æ”¹å–„ |
| Windows/XDG éäº’æ› | OSãŒ `HOME` ã‚’ç„¡è¦– | ãƒ†ã‚¹ãƒˆæ™‚ã«æ­£ã—ã„ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã¸ä½œæˆ | ãƒ†ã‚¹ãƒˆã¯ `HOME` ã®ã¿å¤‰æ›´ | ä¸æ˜ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰ |
| ä½œæˆå…ˆãŒãƒ†ãƒ³ãƒãƒ©ãƒªé…ä¸‹ã‹ | `models_dir` ãŒå®Ÿãƒ›ãƒ¼ãƒ é…ä¸‹ | ãƒ†ãƒ³ãƒãƒ©ãƒªé…ä¸‹ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼ | ãƒ‘ã‚¹ã®è¦ªç¢ºèªãŒãªã„ | è¦æ”¹å–„ |
| æ¨©é™ã‚¨ãƒ©ãƒ¼ | ãƒ†ãƒ³ãƒãƒ©ãƒªãŒèª­ã¿å–ã‚Šå°‚ç”¨ | `init_global_dirs` ãŒ `Err` ã‚’è¿”ã™ | `is_ok` ã—ã‹ç¢ºèªã—ãªã„ | è¦æ”¹å–„ï¼ˆã‚¨ãƒ©ãƒ¼è©³ç´°ç¢ºèªæ¨å¥¨ï¼‰ |
| æ—¢ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ | `models_dir` ã«åŒåãƒ•ã‚¡ã‚¤ãƒ« | ã‚¨ãƒ©ãƒ¼ or ç½®æ›å¤±æ•—ã‚’æ¤œçŸ¥ | `is_dir` ã§æ¤œçŸ¥å¯èƒ½ | è‰¯å¥½ |
| éUTF-8ç’°å¢ƒå€¤ | `HOME` ãŒéUTF-8 | å¾©å…ƒã§å€¤ã‚’ä¿æŒ | `env::var` ã¯å¤±æ•—ã— `None`ã€å‰Šé™¤ã§å¾©æ—§ | è¨±å®¹ã ãŒæ³¨æ„ |

é‡è¦ãªä¸»å¼µã®æ ¹æ‹ ï¼ˆé–¢æ•°å:è¡Œç•ªå·ã®ç›®å®‰ï¼‰
- ä¸è¦ãªunsafeä½¿ç”¨: `test_init_creates_models_directory`: `HOME` è¨­å®šãƒ–ãƒ­ãƒƒã‚¯ï¼ˆç´„17-19è¡Œï¼‰ã€å¾©å…ƒãƒ–ãƒ­ãƒƒã‚¯ï¼ˆç´„47-53è¡Œï¼‰
- ä¸¦è¡Œæ€§ãƒªã‚¹ã‚¯: åŒé–¢æ•°å†…ã§ã‚°ãƒ­ãƒ¼ãƒãƒ« `HOME` ã‚’å¤‰æ›´ã—ã¦ã„ã‚‹ï¼ˆè¨­å®šãƒ»å¾©å…ƒãƒ–ãƒ­ãƒƒã‚¯ï¼‰

## Design & Architecture Suggestions

- ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒä¾å­˜ã®ä½æ¸›
  - `init::init_global_dirs()` ã«ãƒ™ãƒ¼ã‚¹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä¾‹: `&Path`) ã‚’æ¸¡ã›ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã‚„è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã—ã€ãƒ†ã‚¹ãƒˆæ™‚ã¯ãƒ†ãƒ³ãƒãƒ©ãƒªã‚’ç›´æ¥æŒ‡å®š
  - ã‚ã‚‹ã„ã¯ `EnvProvider` ã®ã‚ˆã†ãªæŠ½è±¡ã‚’å°å…¥ã—ã€HOMEè§£æ±ºã‚’æ³¨å…¥å¯èƒ½ã«ã™ã‚‹
- ãƒ†ã‚¹ãƒˆã®å®‰å…¨åŒ–
  - `HOME` å¤‰æ›´ã¯ãƒ—ãƒ­ã‚»ã‚¹å…¨ä½“ã¸ã®å‰¯ä½œç”¨ãŒå¤§ãã„ãŸã‚ã€ãƒ†ã‚¹ãƒˆã®ã‚·ãƒªã‚¢ãƒ«åŒ–ï¼ˆ`serial_test` ã‚¯ãƒ¬ãƒ¼ãƒˆï¼‰ã‚„ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒƒã‚¯ï¼ˆ`static Lazy<Mutex<()>>`ï¼‰ã§ä¿è­·
  - Windows/XDGäº’æ›æ€§ã«å‚™ãˆã€`models_dir` ãŒãƒ†ãƒ³ãƒãƒ©ãƒªé…ä¸‹ã‹ã‚’ `assert!(models_dir.starts_with(temp_dir.path()))` ç­‰ã§ç¢ºèª
- `unsafe` ã®å‰Šé™¤
  - `std::env::set_var` / `remove_var` ã¯å®‰å…¨é–¢æ•°ã€‚`unsafe` ãƒ–ãƒ­ãƒƒã‚¯ã¯å‰Šé™¤

## Testing Strategy (Unit/Integration) with Examples

è¿½åŠ ã™ã¹ããƒ†ã‚¹ãƒˆè¦³ç‚¹:
- æ­£ã—ã„å ´æ‰€ã¸ã®ä½œæˆï¼ˆãƒ†ãƒ³ãƒãƒ©ãƒªé…ä¸‹ï¼‰
- å†å®Ÿè¡Œã®å†ªç­‰æ€§ï¼ˆæ—¢å­˜ã§ã‚‚æˆåŠŸã—ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¾ã¾ï¼‰
- æ¨©é™ã‚¨ãƒ©ãƒ¼ï¼ˆæ›¸è¾¼ä¸å¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰æ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼
- æ—¢å­˜ãŒãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã®ã‚¨ãƒ©ãƒ¼
- ä¸¦è¡Œå®‰å…¨æ€§ï¼ˆã‚·ãƒªã‚¢ãƒ«åŒ– or ãƒ­ãƒƒã‚¯ã§ä¿è­·ï¼‰

ä¾‹1: ãƒ†ãƒ³ãƒãƒ©ãƒªé…ä¸‹ã®ç¢ºèª
```rust
#[test]
fn test_models_dir_is_under_temp_home() {
    let temp_dir = tempfile::TempDir::new().unwrap();
    let original_home = std::env::var("HOME").ok();
    std::env::set_var("HOME", temp_dir.path());

    let _ = codanna::init::init_global_dirs().expect("init failed");
    let models_dir = codanna::init::models_dir();
    assert!(models_dir.starts_with(temp_dir.path()), "models_dir must be under temp HOME");

    if let Some(home) = original_home { std::env::set_var("HOME", home); } else { std::env::remove_var("HOME"); }
}
```

ä¾‹2: å†ªç­‰æ€§
```rust
#[test]
fn test_init_is_idempotent() {
    let temp_dir = tempfile::TempDir::new().unwrap();
    let original_home = std::env::var("HOME").ok();
    std::env::set_var("HOME", temp_dir.path());

    codanna::init::init_global_dirs().expect("first init");
    codanna::init::init_global_dirs().expect("second init"); // should still succeed

    if let Some(home) = original_home { std::env::set_var("HOME", home); } else { std::env::remove_var("HOME"); }
}
```

ä¾‹3: æ—¢å­˜ãŒãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã®å¤±æ•—
```rust
#[test]
fn test_models_dir_is_file_should_fail() {
    let temp_dir = tempfile::TempDir::new().unwrap();
    let original_home = std::env::var("HOME").ok();
    std::env::set_var("HOME", temp_dir.path());

    let models_dir = codanna::init::models_dir();
    std::fs::write(&models_dir, b"not a dir").unwrap(); // create a file

    let result = codanna::init::init_global_dirs();
    assert!(result.is_err(), "should fail when models_dir path is a file");

    if let Some(home) = original_home { std::env::set_var("HOME", home); } else { std::env::remove_var("HOME"); }
}
```

## Refactoring Plan & Best Practices

- `unsafe` ãƒ–ãƒ­ãƒƒã‚¯ã®å‰Šé™¤ï¼ˆé–¢æ•°: test_init_creates_models_directoryï¼‰
- `HOME` å¤‰æ›´ã®ä¸¦è¡Œä¿è­·
  - `serial_test` ã‚’ç”¨ã„ã¦ã‚·ãƒªã‚¢ãƒ«å®Ÿè¡Œ
  - ã‚‚ã—ãã¯ `static ENV_LOCK: once_cell::sync::Lazy<std::sync::Mutex<()>> = ...;` ã‚’å°å…¥ã—ã€ãƒ†ã‚¹ãƒˆé–‹å§‹ã€œçµ‚äº†ã¾ã§ãƒ­ãƒƒã‚¯
- å ´æ‰€æ¤œè¨¼ã®è¿½åŠ 
  - `models_dir` ãŒãƒ†ãƒ³ãƒãƒ©ãƒªé…ä¸‹ã«ã‚ã‚‹ã‹ã‚’ã‚¢ã‚µãƒ¼ãƒˆ
- ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã®æ”¹å–„
  - `assert!(result.is_ok())` ã§ã¯ãªã `result.expect("...")` ã«å¤‰æ›´ã—ã¦å¤±æ•—æ™‚ã«è©³ç´°ã‚’è¡¨ç¤º
- APIè¨­è¨ˆã®æ”¹å–„ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ãŒæ¨å¥¨ï¼‰
  - `init_global_dirs(base_dir: &Path)` ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã®é«˜ã„APIè¨­è¨ˆ
  - ã‚¨ãƒ©ãƒ¼å‹ã®æ˜ç¢ºåŒ–ï¼ˆ`thiserror` ãªã©ï¼‰

Rustç‰¹æœ‰ã®è¦³ç‚¹:
- æ‰€æœ‰æ¨©/å€Ÿç”¨
  - `temp_dir` ã¯æ‰€æœ‰ã—ã€`temp_dir.path()` ã¯å€Ÿç”¨ã‚’è¿”ã™ã€‚`env::set_var` ã¯ `AsRef<OsStr>` ã‚’å—ã‘ä»˜ã‘ã‚‹ãŸã‚å•é¡Œãªã—
- ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ 
  - æ˜ç¤ºçš„ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ä¸è¦ã€‚`temp_dir` ã®å¯¿å‘½ã¯ãƒ†ã‚¹ãƒˆé–¢æ•°å†…ã«é™å®š
- unsafeå¢ƒç•Œ
  - 2ç®‡æ‰€ã®unsafeãƒ–ãƒ­ãƒƒã‚¯ã¯å‰Šé™¤å¯èƒ½ï¼ˆHOMEè¨­å®šãƒ»å¾©å…ƒï¼‰
- ä¸¦è¡Œæ€§
  - ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´ã¯ãƒ‡ãƒ¼ã‚¿ç«¶åˆã®æ¸©åºŠã€‚ãƒ­ãƒƒã‚¯ã‚„ã‚·ãƒªã‚¢ãƒ«åŒ–ãŒå¿…è¦
- ã‚¨ãƒ©ãƒ¼è¨­è¨ˆ
  - `TempDir::new().expect(...)` ã¯ãƒ†ã‚¹ãƒˆã¨ã—ã¦å¦¥å½“
  - `init_global_dirs` ã®ã‚¨ãƒ©ãƒ¼è©³ç´°ãŒä¸æ˜ã®ãŸã‚ã€`expect` ã§è©³ç´°ãƒ­ã‚°ã‚’å¾—ã‚‹æ–¹ãŒãƒ‡ãƒãƒƒã‚°ã«æœ‰ç›Š

## Observability (Logging, Metrics, Tracing)

- ãƒ­ã‚°
  - ç¾åœ¨ `println!` ã‚’ä½¿ç”¨ã€‚ãƒ†ã‚¹ãƒˆæ™‚ã¯ `test-log` ã‚¯ãƒ¬ãƒ¼ãƒˆã‚„ `env_logger` ã‚’ä½µç”¨ã—ã€`log::info!` ã‚’ä½¿ã†ã¨æŸ”è»Ÿ
- ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  - `init_global_dirs()` å†…ã§ã€Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå›æ•°/æˆåŠŸãƒ»å¤±æ•—ã€ã‚’ã‚«ã‚¦ãƒ³ã‚¿åŒ–ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰
- ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°
  - `tracing` ã‚’å°å…¥ã—ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã®é–‹å§‹ãƒ»çµ‚äº†ãƒ»å¤±æ•—ã‚’ã‚¹ãƒ‘ãƒ³ã§å¯è¦–åŒ–ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰

## Risks & Unknowns

- `codanna::init` ã®å…·ä½“çš„ãªãƒ­ã‚¸ãƒƒã‚¯ã¯ä¸æ˜ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰
- OSä¾å­˜ï¼ˆWindows, macOS, Linux/XDGï¼‰ã®HOMEè§£æ±ºãŒä¸ä¸€è‡´ã®å¯èƒ½æ€§
- ä¸¦åˆ—ãƒ†ã‚¹ãƒˆã¨ã®ç›¸äº’å¹²æ¸‰ãƒªã‚¹ã‚¯ãŒé«˜ã„ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒã‚’å…±æœ‰ï¼‰
- `init_global_dirs` ã®æˆ»ã‚Šå‹ãƒ»ã‚¨ãƒ©ãƒ¼å‹ãƒ»ä½œæˆå ´æ‰€ã®ç´°éƒ¨ä»•æ§˜ãŒä¸æ˜ï¼ˆã“ã®ãƒãƒ£ãƒ³ã‚¯ã«ã¯ç¾ã‚Œãªã„ï¼‰